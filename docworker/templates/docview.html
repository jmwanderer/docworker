{% extends "base.html" %}

{% block backlink %}
<a href="{{ url_for('analysis.doclist') }}">Document List</a>
{% endblock %}
{% block body%}
  
  <h1>Document View</h1>

  <p>
    The Document View page displays the opened document split up into
    blocks of text plus any new text that has been generated by running
    GPT functions. Blocks are shown in abbreviated form on this page
    and can be opened in a new page to view the full text.
  </p>
  <p>
    From this page, you can do the following:
    <form action="{{ url_for('analysis.dispatch')}}" method="get">
      <input type="hidden" id="doc" name="doc" value="{{ doc }}"/>       
      <table>
	<tr>
	  <td>
	    Open a page to run a GPT operation on all text in the document.
	    (This is a good place to start.)
	  </td>
	  <td>	  
	  <input name="ProcessDoc" type="submit" value="Go To Process Document"/>	  
	  </td>
	</tr>
	<tr>
	  <td>
	    Open a page to select specific text items on which to
	    run GPT operations.
	  </td>
	  <td>
	    <input id="ProcessBlocks" name="ProcessBlocks" type="submit"
		   value="Go To Process Text"/>
	  </td>
	</tr>

	<tr>
	  <td>
	    Open a page to select specific text items for download and export.	    	  </td>
	  <td>
	    <input id="ExportBlocks" name="ExportBlocks" type="submit"      
		   value="Go To Export Text"/>
	  </td>
	</tr>
      </table>
    </form>
  </p>
  <hr>

  <h2>Generated Text:</h2>
  Text created by running GPT functions.
  <div>
    {% if session.final_completion_count() == 0 %}
    <b>None</b>

    {% else %}
    <table style="border-spacing:5px">
      <tr>
	<th>Label</th>
	<th>Content</th>
	<th>Size (tokens)</th>
      </tr>
	
      {% for item in session.get_ordered_items() %}
      {% if not item.is_doc_segment() and item.is_final_result() %}      
      <tr id="{{ item.name() }}">
	<td style="vertical-align: top;" NOWRAP>
	  <a href="{{ url_for('analysis.segview', doc=doc, top=item.name(), item=item.name()) }}">
	    {{ item.name() }}
	  </a>
	</td>

	<td style="background:{{ session.item_color(item) }};">
	  [ {{ item.prompt_name(session) }} ]
	  <div style="background:{{ session.item_color(item) }};padding:2px;>">
	    {{ session.snippet_text(item.text())|e }}
	  </div>
	</td>

	<td style="vertical-align: top;">	  
	  ({{ item.token_count() }})
	</td>
      </tr>
      {% endif %}
      {% endfor %}
    </table>
    {% endif %}    
  </div>

  <h2>Document Text:</h2>
  <p>
    The document has been split into <b> {{ session.segment_count() }}</b> blocks.
  </p>
  <div>
    <table style="border-spacing:5px">      
      <tr>
	<th>Label</th>
	<th/>
	<th>Content</th>
	<th>Size (tokens)</th>
      </tr>
	
      {% for item in session.get_ordered_items() %}
      {% if item.is_doc_segment() %}      
      <tr id="{{ item.name() }}">
	<td style="vertical-align: top;" NOWRAP>
	  <a href="{{ url_for('analysis.segview', doc=doc, item=item.name()) }}">
	    {{ item.name() }}
	  </a>
	</td>

	<td style="background:{{ session.item_color(item) }};" colspan="2">
	  <div style="padding:2px;">
	    {{ session.snippet_text(item.text()) | e }}
	  </div>
	</td>
	
	<td style="vertical-align: top;">	  
	  ({{ item.token_count() }})
	</td>
      </tr>
      {% endif %}
      {% endfor %}
    </table>
  </div>

  <table>
    <tr>
      <td>Doc Size:</td>
      <td>{{ session.doc_tokens() }} tokens</td>
    </tr>
    <tr>
      <td>Generated Size:</td>
      <td>{{ session.gen_tokens() }} tokens</td>
    </tr>
    <tr>
      <td>Generation Cost:</td>
      <td>{{ session.gen_cost_tokens() }} tokens</td>      
    </tr>
  </table>
{% endblock %}
